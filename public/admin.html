<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREENCYCLE - Quản lý</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.css" rel="stylesheet" />

    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    
    <header id="navbar-placeholder"></header>

    <main class="content" style="max-width: 7xl; margin: 0 auto; padding: 2rem;">
        <h1 class="text-3xl font-bold mb-6 text-red-700 dark:text-red-500">Trang Quản lý (Admin)</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            
            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-blue-700 dark:text-blue-400">Quản lý Điểm Thu Gom</h2>
                <form id="addPointForm" class="space-y-4 mb-6 pb-6 border-b dark:border-gray-700">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tên điểm</label>
                        <input type="text" id="pointName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Điểm thu gom Hà Nội 1" required>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Địa chỉ</label>
                        <input type="text" id="pointAddress" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="123 Đường Láng" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5">Thêm Điểm</button>
                </form>
                <ul id="pointsList" class="space-y-3 max-h-60 overflow-y-auto"><p class="text-gray-500">Đang tải...</p></ul>
            </div>

            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-purple-700 dark:text-purple-400">Tạo Tài Khoản "Bên Mua"</h2>
                <form id="createRecyclerForm" class="space-y-4">
                    <div><input type="text" id="recyclerName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Tên Doanh nghiệp" required></div>
                    <div><input type="email" id="recyclerEmail" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Email" required></div>
                    <div><input type="password" id="recyclerPassword" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Mật khẩu" required></div>
                    <button type="submit" class="w-full text-white bg-purple-700 hover:bg-purple-800 font-medium rounded-lg text-sm px-5 py-2.5">Tạo Tài Khoản</button>
                </form>
            </div>
        </div> 

        <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700 mb-6">
             <h2 class="text-xl font-semibold mb-4 text-green-700 dark:text-green-400">Quản lý Bài đăng Rác thải</h2>
             <div class="relative overflow-x-auto shadow-md sm:rounded-lg max-h-96">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3">Loại rác</th>
                            <th scope="col" class="px-6 py-3">KL (kg)</th>
                            <th scope="col" class="px-6 py-3">Người Đăng</th>
                            <th scope="col" class="px-6 py-3">Trạng thái</th>
                            <th scope="col" class="px-6 py-3">Người Nhận</th>
                            <th scope="col" class="px-6 py-3">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="wasteListAdmin">
                        <tr class="bg-white border-b"><td colspan="6" class="px-6 py-4 text-center">Đang tải...</td></tr>
                    </tbody>
                </table>
             </div>
        </div>

        <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
             <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Quản lý Tất cả Người dùng</h2>
             <div class="relative overflow-x-auto shadow-md sm:rounded-lg max-h-80">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3">Tên</th>
                            <th scope="col" class="px-6 py-3">Email</th>
                            <th scope="col" class="px-6 py-3">Vai trò</th>
                            <th scope="col" class="px-6 py-3">Trạng thái</th>
                            <th scope="col" class="px-6 py-3">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <tr class="bg-white border-b"><td colspan="5" class="px-6 py-4 text-center">Đang tải...</td></tr>
                    </tbody>
                </table>
             </div>
        </div>

    </main> 

    <footer id="footer-placeholder"></footer>

    <script src="js/jwt-decode.min.js"></script> 
    <script src="script.js"></script> 
    <script src="js/navbar.js"></script> 
    <script src="js/footer.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.js"></script>
    
    <script>
        const token = localStorage.getItem('token');
        
        // Các Element
        const listElement = document.getElementById('pointsList');
        const addPointForm = document.getElementById('addPointForm');
        const createRecyclerForm = document.getElementById('createRecyclerForm');
        const userListBody = document.getElementById('userList');
        const wasteListBody = document.getElementById('wasteListAdmin'); // MỚI

        // Check Admin
        (function checkAdmin() {
            if (!token) { window.location.href = '/login.html'; return; }
            try {
                const decoded = jwt_decode(token);
                if (decoded.role !== 'admin') { window.location.href = '/dashboard.html'; return; }
                
                // Load tất cả dữ liệu
                loadCollectionPoints();
                loadUsers();
                loadAllWastes(); // MỚI
            } catch (e) { localStorage.removeItem('token'); window.location.href = '/login.html'; }
        })();
        
        // --- 1. LOGIC ĐIỂM THU GOM (Đơn giản) ---
        async function loadCollectionPoints() {
            try {
                const res = await fetch('/api/collection-points');
                const points = await res.json();
                listElement.innerHTML = '';
                points.forEach(point => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-gray-50 rounded flex justify-between items-center';
                    li.innerHTML = `<div><strong>${point.name}</strong><p class="text-sm">${point.address}</p></div>
                        <button onclick="deletePoint('${point.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>`;
                    listElement.appendChild(li);
                });
            } catch (err) {}
        }
        addPointForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('pointName').value;
            const address = document.getElementById('pointAddress').value;
            try {
                const res = await fetch('/api/collection-points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name, address }) // Gửi dữ liệu đơn giản
                });
                if ((await res.json()).success) { addPointForm.reset(); loadCollectionPoints(); showToast('Thêm thành công'); }
            } catch (err) {}
        });
        async function deletePoint(id) {
            if(!confirm('Xóa điểm này?')) return;
            await fetch(`/api/collection-points/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            loadCollectionPoints();
        }

        // --- 2. LOGIC TẠO RECYCLER ---
        createRecyclerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('recyclerName').value,
                email: document.getElementById('recyclerEmail').value,
                password: document.getElementById('recyclerPassword').value
            };
            try {
                const res = await fetch('/api/auth/admin/create-recycler', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                showToast(json.message, json.success);
                if (json.success) { createRecyclerForm.reset(); loadUsers(); }
            } catch (err) { showToast('Lỗi: ' + err.message, false); }
        });

        // --- 3. LOGIC QUẢN LÝ BÀI ĐĂNG RÁC (MỚI) ---
        async function loadAllWastes() {
            try {
                const res = await fetch('/api/auth/waste/admin/all', { headers: { 'Authorization': `Bearer ${token}` } });
                const wastes = await res.json();
                
                wasteListBody.innerHTML = '';
                if (wastes.length === 0) {
                    wasteListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Không có bài đăng nào.</td></tr>';
                    return;
                }

                wastes.forEach(w => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    
                    // Trạng thái
                    let statusHtml = `<span class="text-yellow-600 font-bold">Đang chờ</span>`;
                    if (w.status === 'collected') statusHtml = `<span class="text-green-600 font-bold">Đã xong</span>`;
                    
                    // Người nhận (Collector)
                    let collectorHtml = '<span class="text-gray-400">-</span>';
                    if (w.collector) {
                        collectorHtml = `<div class="text-sm">
                            <div class="font-medium text-gray-900">${w.collector.name}</div>
                            <div class="text-gray-500">${w.collector.email}</div>
                        </div>`;
                    }

                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900">${w.type}</td>
                        <td class="px-6 py-4">${w.quantity}</td>
                        <td class="px-6 py-4">
                            <div>${w.ownerName}</div>
                            <div class="text-xs text-gray-500">${w.ownerEmail}</div>
                        </td>
                        <td class="px-6 py-4">${statusHtml}</td>
                        <td class="px-6 py-4">${collectorHtml}</td> <td class="px-6 py-4">
                            <button onclick="deleteWaste('${w.id}')" class="text-red-600 hover:underline">Xóa</button>
                        </td>
                    `;
                    wasteListBody.appendChild(tr);
                });
            } catch(err) { console.error(err); }
        }

        async function deleteWaste(id) {
            if(!confirm('Admin: Bạn chắc chắn muốn xóa bài đăng này?')) return;
            try {
                await fetch(`/api/auth/waste/admin/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                loadAllWastes();
                showToast('Đã xóa bài đăng', true);
            } catch(e) { showToast('Lỗi xóa', false); }
        }

        // --- 4. LOGIC QUẢN LÝ USER ---
        async function loadUsers() {
            try {
                const res = await fetch('/api/auth/admin/users', { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();
                userListBody.innerHTML = '';
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    const statusText = u.enabled ? '<span class="text-green-500">Hoạt động</span>' : '<span class="text-red-500">Đã khóa</span>';
                    const btnText = u.enabled ? 'Khóa' : 'Mở khóa';
                    const btnColor = u.enabled ? 'text-red-600' : 'text-green-600';
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900">${u.name}</td>
                        <td class="px-6 py-4">${u.email}</td>
                        <td class="px-6 py-4">${u.role}</td>
                        <td class="px-6 py-4">${statusText}</td>
                        <td class="px-6 py-4"><button onclick="toggleUser('${u.uid}', ${u.enabled})" class="${btnColor} hover:underline">${btnText}</button></td>
                    `;
                    userListBody.appendChild(tr);
                });
            } catch(err) {}
        }
        async function toggleUser(uid, status) {
            if(!confirm(`Bạn muốn ${status ? 'KHÓA' : 'MỞ KHÓA'} tài khoản này?`)) return;
            await fetch(`/api/auth/admin/user/${uid}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ enabled: !status })
            });
            loadUsers();
        }
    </script>
</body>
</html>