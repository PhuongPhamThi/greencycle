<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREENCYCLE - Quản lý</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.css" rel="stylesheet" />

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style cho các nút chọn ngày */
        .day-label {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 99px; /* rounded-full */
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151; /* gray-700 */
            transition: all 0.2s ease;
        }
        input[type="checkbox"].hidden:checked + .day-label {
            background-color: #10b981; /* green-500 */
            color: white;
            border-color: #10b981;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    
    <header id="navbar-placeholder"></header>

    <main class="content" style="max-width: 7xl; margin: 0 auto; padding: 2rem;">
        <h1 class="text-3xl font-bold mb-6 text-red-700 dark:text-red-500">Trang Quản lý (Admin)</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-blue-700 dark:text-blue-400">Quản lý Điểm Thu Gom</h2>
                
                <form id="addPointForm" class="space-y-4 mb-6 pb-6 border-b dark:border-gray-700">
                    <div>
                        <label for="pointName" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tên điểm</label>
                        <input type="text" id="pointName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="Điểm thu gom Hà Nội 1" required>
                    </div>
                    <div>
                        <label for="pointAddress" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Địa chỉ</label>
                        <input type="text" id="pointAddress" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="123 Đường Láng, Đống Đa" required>
                    </div>
                    
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Ngày hoạt động</label>
                        <ul class="flex flex-wrap gap-2">
                            <li><input type="checkbox" id="day-mon" value="T2" class="hidden peer"><label for="day-mon" class="day-label">T2</label></li>
                            <li><input type="checkbox" id="day-tue" value="T3" class="hidden peer"><label for="day-tue" class="day-label">T3</label></li>
                            <li><input type="checkbox" id="day-wed" value="T4" class="hidden peer"><label for="day-wed" class="day-label">T4</label></li>
                            <li><input type="checkbox" id="day-thu" value="T5" class="hidden peer"><label for="day-thu" class="day-label">T5</label></li>
                            <li><input type="checkbox" id="day-fri" value="T6" class="hidden peer"><label for="day-fri" class="day-label">T6</label></li>
                            <li><input type="checkbox" id="day-sat" value="T7" class="hidden peer"><label for="day-sat" class="day-label">T7</label></li>
                            <li><input type="checkbox" id="day-sun" value="CN" class="hidden peer"><label for="day-sun" class="day-label">CN</label></li>
                        </ul>
                    </div>
                    <div>
                        <label for="pointAccepted" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Loại rác chấp nhận</label>
                        <input type="text" id="pointAccepted" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="Nhựa, Giấy, Hữu cơ (không dầu mỡ)">
                    </div>
                    <div>
                        <label for="pointPhone" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Số điện thoại liên hệ</label>
                        <input type="tel" id="pointPhone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="090123456">
                    </div>
                    <div>
                        <label for="pointImageUrl" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Link Hình ảnh (URL)</label>
                        <input type="url" id="pointImageUrl" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="https://imgur.com/...">
                    </div>
                    
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Thêm Điểm</button>
                </form>
                
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Các Điểm Thu Gom Hiện Tại</h3>
                <ul id="pointsList" class="space-y-3 max-h-60 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400">Đang tải...</p>
                </ul>
            </div>

            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-purple-700 dark:text-purple-400">Tạo Tài Khoản "Bên Mua"</h2>
                <p class="text-sm text-gray-600 mb-4 dark:text-gray-400">Tạo tài khoản cho đối tác (công ty phân bón, HTX...) để họ có thể đăng nhập và "Nhận Thu Gom" rác.</p>
                
                <form id="createRecyclerForm" class="space-y-4">
                    <div>
                        <label for="recyclerName" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tên Doanh nghiệp</label>
                        <input type="text" id="recyclerName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Công ty TNHH Môi trường Xanh" required>
                    </div>
                    <div>
                        <label for="recyclerEmail" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email đăng nhập</label>
                        <input type="email" id="recyclerEmail" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="contact@moitruongxanh.com" required>
                    </div>
                    <div>
                        <label for="recyclerPassword" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Mật khẩu tạm thời</label>
                        <input type="password" id="recyclerPassword" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-800">Tạo Tài Khoản Recycler</button>
                </form>
            </div>

        </div> 
        
        <div class="block p-6 mt-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
             <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Quản lý Tất cả Người dùng (Bên Bán & Bên Mua)</h2>
             <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Tên</th>
                            <th scope="col" class="px-6 py-3">Email</th>
                            <th scope="col" class="px-6 py-3">Vai trò</th>
                            <th scope="col" class="px-6 py-3">Trạng thái</th>
                            <th scope="col" class="px-6 py-3">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                            <td colspan="5" class="px-6 py-4 text-center">Đang tải danh sách người dùng...</td>
                        </tr>
                    </tbody>
                </table>
             </div>
        </div>

    </main> 

    <footer id="footer-placeholder"></footer>

    <script src="js/jwt-decode.min.js"></script> 
    <script src="script.js"></script> 
    <script src="js/navbar.js"></script> 
    <script src="js/footer.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.js"></script>
    
    <script>
    const token = localStorage.getItem('token');
    const listElement = document.getElementById('pointsList');
    const addPointForm = document.getElementById('addPointForm');
    const createRecyclerForm = document.getElementById('createRecyclerForm');
    const userListBody = document.getElementById('userList');

    // (checkAdmin() giữ nguyên)
    (function checkAdmin() {
        if (!token) {
            showToast('Vui lòng đăng nhập!', false);
            return window.location.href = '/login.html';
        }
        try {
            const decoded = jwt_decode(token);
            if (decoded.role !== 'admin') {
                showToast('Bạn không có quyền truy cập trang này!', false);
                return window.location.href = '/dashboard.html';
            }
            // Tải dữ liệu khi xác nhận là admin
            loadCollectionPoints();
            loadUsers();
        } catch (e) {
            showToast('Phiên làm việc không hợp lệ, vui lòng đăng nhập lại.', false);
            localStorage.removeItem('token');
            return window.location.href = '/login.html';
        }
    })();
    
    // === LOGIC ĐIỂM THU GOM ===
    
    async function loadCollectionPoints() {
        try {
            const res = await fetch('/api/collection-points');
            const points = await res.json();
            listElement.innerHTML = ''; // Xóa danh sách cũ
            if (points.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Chưa có điểm thu gom nào.</p>';
                return;
            }
            points.forEach(point => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-100 rounded shadow-sm flex justify-between items-center dark:bg-gray-700';
                li.innerHTML = `
                    <div>
                        <strong class="text-gray-800 dark:text-white">${point.name}</strong>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${point.address}</p>
                    </div>
                    <button onclick="deletePoint('${point.id}')" class="text-red-500 hover:text-red-700 bg-transparent hover:bg-red-100 p-2 rounded-full dark:hover:bg-gray-600">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                listElement.appendChild(li);
            });
        } catch (err) { 
            showToast('Lỗi tải danh sách điểm: ' + err.message, false); 
        }
    }

    // XÓA MỘT ĐIỂM
    async function deletePoint(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa điểm này không?')) return;
        try {
            const res = await fetch(`/api/collection-points/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            showToast(data.message, data.success);
            if (data.success) {
                loadCollectionPoints(); // Tải lại danh sách
            }
        } catch (err) { 
            showToast('Lỗi khi xóa: ' + err.message, false); 
        }
    }
addPointForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedDays = [];
            document.querySelectorAll('input[type="checkbox"][id^="day-"]:checked').forEach(cb => {
                selectedDays.push(cb.value);
            });
            
            const pointData = {
                name: document.getElementById('pointName').value,
                address: document.getElementById('pointAddress').value,
                accepted: document.getElementById('pointAccepted').value || '',
                phone: document.getElementById('pointPhone').value || '',
                imageUrl: document.getElementById('pointImageUrl').value || ''
            };


            try {
                const res = await fetch('/api/collection-points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(pointData)
                });
                const data = await res.json();
                showToast(data.message, data.success);
                if (data.success) {
                    addPointForm.reset();
                    loadCollectionPoints();
                }
            } catch (err) {
                showToast('Lỗi: ' + err.message, false);
            }
        });
        
        // (Code ẩn của loadCollectionPoints và deletePoint)
        async function loadCollectionPoints() {
            try {
                const res = await fetch('/api/collection-points');
                const points = await res.json();
                listElement.innerHTML = '';
                if (points.length === 0) {
                    listElement.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Chưa có điểm thu gom nào.</p>';
                    return;
                }
                points.forEach(point => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-gray-100 rounded shadow-sm flex justify-between items-center dark:bg-gray-700';
                    li.innerHTML = `
                        <div>
                            <strong class="text-gray-800 dark:text-white">${point.name}</strong>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${point.address}</p>
                        </div>
                        <button onclick="deletePoint('${point.id}')" class="text-red-500 hover:text-red-700 bg-transparent hover:bg-red-100 p-2 rounded-full dark:hover:bg-gray-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    listElement.appendChild(li);
                });
            } catch (err) { showToast('Lỗi tải danh sách: ' + err.message, false); }
        }
        async function deletePoint(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa điểm này không?')) return;
            try {
                const res = await fetch(`/api/collection-points/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                showToast(data.message, data.success);
                if (data.success) {
                    loadCollectionPoints();
                }
            } catch (err) { showToast('Lỗi: ' + err.message, false); }
        }

    // === LOGIC TẠO TÀI KHOẢN RECYCLER ===
    createRecyclerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('recyclerName').value;
        const email = document.getElementById('recyclerEmail').value;
        const password = document.getElementById('recyclerPassword').value;
        try {
            const res = await fetch('/api/auth/admin/create-recycler', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, email, password })
            });
            const data = await res.json();
            showToast(data.message, data.success);
            if (data.success) {
                createRecyclerForm.reset();
                loadUsers(); // Tải lại danh sách người dùng
            }
        } catch (err) {
            showToast('Lỗi khi tạo recycler: ' + err.message, false);
        }
    });

    // === LOGIC QUẢN LÝ NGƯỜI DÙNG ===

    // Tải danh sách tất cả người dùng
    async function loadUsers() {
        try {
            const res = await fetch('/api/auth/admin/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            
            userListBody.innerHTML = ''; // Xóa bảng
            if (users.length === 0) {
                userListBody.innerHTML = '<tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700"><td colspan="5" class="px-6 py-4 text-center">Không có người dùng nào.</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                
                let roleText = user.role;
                if(user.role === 'household') roleText = 'Hộ Gia đình (Bên Bán)';
                if(user.role === 'business') roleText = 'Doanh nghiệp (Bên Bán)';
                if(user.role === 'recycler') roleText = 'Recycler (Bên Mua)';
                if(user.role === 'admin') roleText = 'Admin';
                
                const statusClass = user.enabled ? "text-green-500" : "text-red-500";
                const statusText = user.enabled ? "Hoạt động" : "Bị vô hiệu hóa";
                
                const buttonClass = user.enabled 
                    ? "font-medium text-red-600 dark:text-red-500 hover:underline"
                    : "font-medium text-green-600 dark:text-green-500 hover:underline";
                const buttonText = user.enabled ? "Vô hiệu hóa" : "Kích hoạt";

                tr.innerHTML = `
                    <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        ${user.name}
                    </th>
                    <td class="px-6 py-4">${user.email}</td>
                    <td class="px-6 py-4">${roleText}</td>
                    <td class="px-6 py-4 font-medium ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4">
                        <button type="button" class="${buttonClass}" onclick="toggleUserStatus('${user.uid}', ${user.enabled})">
                            ${buttonText}
                        </button>
                    </td>
                `;
                userListBody.appendChild(tr);
            });
        } catch (err) {
            showToast('Lỗi tải danh sách người dùng: ' + err.message, false);
        }
    }

    // Vô hiệu hóa / Kích hoạt người dùng
    async function toggleUserStatus(userId, currentStatus) {
        const newStatus = !currentStatus;
        const actionText = newStatus ? "kích hoạt" : "vô hiệu hóa";
        
        if (!confirm(`Bạn có chắc chắn muốn ${actionText} người dùng này không?`)) return;

        try {
            const res = await fetch(`/api/auth/admin/user/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ enabled: newStatus }) // Gửi trạng thái MỚI
            });
            const data = await res.json();
            
            showToast(data.message, data.success);
            if (data.success) {
                loadUsers(); // Tải lại danh sách
            }
        } catch (err) {
            showToast('Lỗi khi cập nhật: ' + err.message, false);
        }
    }
</script>
</body>
</html>