<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREENCYCLE - Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.css" rel="stylesheet" />
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <header id="navbar-placeholder"></header>

    <main class="content" style="max-width: 7xl; margin: 0 auto; padding: 2rem;">
        <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">Chào mừng, <span id="userName" class="text-green-500">...</span></h2>
                <p class="text-lg text-gray-700 dark:text-gray-400">
                    Điểm xanh của bạn: <span id="points" class="font-bold text-yellow-500">...</span>
                </p>
                
                <h3 class="text-lg font-semibold mt-6 mb-4 text-gray-900 dark:text-white">Đăng tải Chất thải Mới</h3>
                
                <form id="postForm" class="space-y-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Loại chất thải</label>
                        <input type="text" name="type" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Vỏ trái cây, rau hỏng..." required>
                    </div>
                    
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="file_input">Hình ảnh rác (Tùy chọn)</label>
                        <input class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none" id="wasteImage" type="file" accept="image/*">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">SVG, PNG, JPG (Tối đa 5MB).</p>
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Khối lượng (kg)</label>
                        <input type="number" name="quantity" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="2.5" step="0.1" required>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Mô tả vị trí</label>
                        <input type="text" name="locationName" id="locationName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Nhà tôi, 123 ABC" required>
                    </div>
                    <input type="hidden" name="lat" id="lat"><input type="hidden" name="lng" id="lng">
                    
                    <div class="flex gap-2">
                         <button type="button" id="getLocationBtn" class="flex-1 text-gray-900 bg-yellow-400 hover:bg-yellow-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                            <i class="fas fa-map-marker-alt mr-2"></i> Lấy vị trí
                        </button>
                        <button type="submit" id="submitBtn" class="flex-1 text-white bg-green-700 hover:bg-green-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                            Đăng tải
                        </button>
                    </div>
                </form>
            </div>

            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Trạng thái Rác của bạn</h3>
                <ul id="wasteList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    <p class="text-gray-500">Đang tải dữ liệu...</p>
                </ul>
            </div>
        </div>
    </main>

    <footer id="footer-placeholder"></footer>

    <script src="js/jwt-decode.min.js"></script>
    <script src="script.js"></script> 
    <script src="js/navbar.js"></script> 
    <script src="js/footer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return; }

            const decoded = jwt_decode(token);
            const userId = decoded.userId;
            document.getElementById('userName').textContent = decoded.name || 'User';

            // Lấy điểm
            fetch('/api/auth/points', { headers: { Authorization: `Bearer ${token}` } })
                .then(res => res.json())
                .then(data => document.getElementById('points').textContent = data.success ? data.points : 'Lỗi');

            // Hàm chuyển File thành Base64
            const convertToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = (error) => reject(error);
                });
            };

            // Hàm lấy danh sách rác
            async function fetchWasteList() {
                const listElement = document.getElementById('wasteList');
                try {
                    const res = await fetch(`/api/auth/waste/${userId}`, {
                        headers: { Authorization: `Bearer ${token}` },
                    });
                    if (!res.ok) throw new Error("Lỗi tải danh sách");
                    const data = await res.json();
                    listElement.innerHTML = '';

                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(waste => {
                            let statusBadge = waste.status === 'collected' 
                                ? `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">Đã nhận</span>`
                                : `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded">Đang chờ</span>`;
                            
                            // Kiểm tra có ảnh không
                            let imageHtml = '';
                            if (waste.image) {
                                imageHtml = `<img src="${waste.image}" class="w-12 h-12 object-cover rounded-md border border-gray-200 ml-2" title="Có ảnh đính kèm">`;
                            }

                            const li = document.createElement('li');
                            li.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center';
                            li.innerHTML = `
                                <div class="flex items-center">
                                    ${imageHtml}
                                    <div class="ml-2">
                                        <p class="font-medium text-gray-900">${waste.type} (${waste.quantity}kg)</p>
                                        <p class="text-xs text-gray-500">${waste.location}</p>
                                    </div>
                                </div>
                                ${statusBadge}
                            `;
                            listElement.appendChild(li);
                        });
                    } else {
                        listElement.innerHTML = '<p class="text-gray-500 italic">Bạn chưa đăng tải mục rác nào.</p>';
                    }
                } catch (err) {
                    listElement.innerHTML = `<p class="text-red-500">Lỗi: ${err.message}</p>`;
                }
            }

            fetchWasteList();

            // Logic Lấy vị trí
            document.getElementById('getLocationBtn').addEventListener('click', () => {
                if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => {
                    document.getElementById('lat').value = p.coords.latitude;
                    document.getElementById('lng').value = p.coords.longitude;
                    document.getElementById('locationName').value = `Vị trí: ${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
                    showToast('Đã lấy vị trí!', true);
                }, () => showToast('Không thể lấy vị trí.', false));
            });

            // Logic Submit Form (CÓ XỬ LÝ ẢNH)
            document.getElementById('postForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = "Đang xử lý...";

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                // Xử lý file ảnh
                const fileInput = document.getElementById('wasteImage');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        showToast("Ảnh quá lớn! Vui lòng chọn ảnh dưới 5MB.", false);
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Đăng tải";
                        return;
                    }
                    try {
                        data.image = await convertToBase64(file);
                    } catch (err) {
                        showToast("Lỗi xử lý ảnh", false);
                    }
                }

                fetch('/api/auth/waste/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify(data),
                })
                .then(res => res.json())
                .then(d => {
                    showToast(d.message, d.success);
                    if(d.success) {
                        e.target.reset();
                        fetchWasteList();
                    }
                })
                .catch(err => showToast('Lỗi: ' + err.message, false))
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Đăng tải";
                });
            });
        });
    </script>
</body>
</html>