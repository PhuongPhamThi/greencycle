<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREENCYCLE - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.css" rel="stylesheet" />
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <header id="navbar-placeholder"></header>

    <main class="content" style="max-width: 7xl; margin: 0 auto; padding: 2rem;">
        <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">Chào mừng, <span id="userName" class="text-green-500">...</span></h2>
                <p class="text-lg text-gray-700 dark:text-gray-400">Điểm xanh: <span id="points" class="font-bold text-yellow-500">...</span></p>
                
                <h3 class="text-lg font-semibold mt-6 mb-4 text-gray-900 dark:text-white">Đăng tải Chất thải Mới</h3>
                <form id="postForm" class="space-y-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Loại chất thải</label>
                        <input type="text" name="type" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Ví dụ: Vỏ trái cây" required>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Khối lượng (kg)</label>
                        <input type="number" name="quantity" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="2.5" step="0.1" required>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Mô tả vị trí</label>
                        <input type="text" name="locationName" id="locationName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Nhà tôi, 123 ABC" required>
                    </div>
                    <input type="hidden" name="lat" id="lat"><input type="hidden" name="lng" id="lng">
                    <button type="button" id="getLocationBtn" class="w-full text-gray-900 bg-yellow-400 hover:bg-yellow-500 font-medium rounded-lg text-sm px-5 py-2.5">Lấy vị trí</button>
                    <button type="submit" class="w-full text-white bg-green-700 hover:bg-green-800 font-medium rounded-lg text-sm px-5 py-2.5">Đăng tải</button>
                </form>
            </div>

            <div class="block p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Trạng thái Rác của bạn</h3>
                <ul id="wasteList" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                    <p class="text-gray-500">Đang tải dữ liệu...</p>
                </ul>
                <!-- <h3 class="text-lg font-semibold mt-6 mb-4 text-gray-900 dark:text-white">Trạng thái Thu gom</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Rác bạn đăng sẽ tự động hiển thị cho "Bên Mua".</p> -->
            </div>
        </div>
    </main>

    <footer id="footer-placeholder"></footer>
    <script src="js/jwt-decode.min.js"></script><script src="script.js"></script><script src="js/navbar.js"></script><script src="js/footer.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.4.1/flowbite.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return; }

            const decoded = jwt_decode(token);
            const userId = decoded.userId;
            document.getElementById('userName').textContent = decoded.name || 'User';

            // Lấy điểm
            fetch('/api/auth/points', { headers: { Authorization: `Bearer ${token}` } })
                .then(res => res.json())
                .then(data => document.getElementById('points').textContent = data.success ? data.points : 'Lỗi');

            // Lấy danh sách (CÓ TIMEOUT 5 GIÂY)
            const listElement = document.getElementById('wasteList');
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // Hủy sau 5 giây

            fetch(`/api/auth/waste/${userId}`, {
                headers: { Authorization: `Bearer ${token}` },
                signal: controller.signal
            })
            .then(res => {
                if (!res.ok) throw new Error(`Lỗi Server ${res.status}`);
                return res.json();
            })
            .then(data => {
                clearTimeout(timeoutId);
                listElement.innerHTML = '';
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(waste => {
                        let statusBadge = waste.status === 'collected' 
                            ? `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">Đã nhận</span>`
                            : `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded">Đang chờ</span>`;
                        
                        const li = document.createElement('li');
                        li.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center';
                        li.innerHTML = `<div><p class="font-medium">${waste.type} (${waste.quantity}kg)</p><p class="text-xs text-gray-500">${waste.location}</p></div>${statusBadge}`;
                        listElement.appendChild(li);
                    });
                } else {
                    listElement.innerHTML = '<p class="text-gray-500 italic">Bạn chưa đăng tải mục rác nào.</p>';
                }
            })
            .catch(err => {
                if (err.name === 'AbortError') {
                    listElement.innerHTML = '<p class="text-red-500">Kết nối quá lâu. Server có thể chưa được cập nhật.</p>';
                } else {
                    listElement.innerHTML = `<p class="text-red-500">Lỗi: ${err.message}</p>`;
                }
            });

            // Logic đăng tải (Giữ nguyên)
            document.getElementById('getLocationBtn').addEventListener('click', () => {
                if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => {
                    document.getElementById('lat').value = p.coords.latitude;
                    document.getElementById('lng').value = p.coords.longitude;
                    document.getElementById('locationName').value = `Vị trí: ${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
                });
            });
            document.getElementById('postForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                fetch('/api/auth/waste/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify(data),
                }).then(res => res.json()).then(d => {
                    showToast(d.message, d.success);
                    if(d.success) setTimeout(() => location.reload(), 1000);
                });
            });
        });
    </script>
</body>
</html>